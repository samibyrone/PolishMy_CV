<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit CV - CVLatex</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --red-accent: #ff2d2d;
            --footer-black: #111111;
            --footer-white: #fff;
            --footer-red: #ff2d2d;
            --footer-link: #ff2d2d;
            --footer-link-hover: #fff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: white;
            color: #111;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif;
            line-height: 1.6;
            font-size: 16px;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            min-height: 100vh;
        }

        /* Navigation */
        .navbar {
            background: #fff;
            border-bottom: 1px solid #ececec;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            padding: 18px 0;
            position: sticky;
            top: 0;
            width: 100%;
            z-index: 1000;
        }

        .navbar-brand {
            font-weight: 900;
            font-size: 22px;
            color: #111 !important;
            letter-spacing: -0.03em;
        }

        .navbar-brand i {
            color: var(--red-accent);
        }

        .back-button {
            color: #222;
            font-weight: 700;
            font-size: 15px;
            border-radius: 8px;
            padding: 8px 18px;
            background: #f7f7f7;
            border: none;
            transition: background 0.2s;
        }

        .back-button:hover {
            background: #ececec;
            color: #111;
        }

        /* Main Content */
        .main-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 60px 24px 100px;
        }

        .page-header {
            text-align: center;
            margin-bottom: 60px;
            opacity: 0;
            animation: fadeInUp 0.8s ease-out 0.2s forwards;
        }

        .page-title {
            font-size: 64px;
            font-weight: 900;
            color: #111;
            margin-bottom: 20px;
            letter-spacing: -0.04em;
            line-height: 1.05;
            text-transform: uppercase;
        }

        .page-subtitle {
            font-size: 22px;
            color: #444;
            font-weight: 500;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.5;
        }

        /* Form Container */
        .form-container {
            background: white;
            border-radius: 20px;
            border: 1px solid #ececec;
            box-shadow: 0 4px 32px rgba(0,0,0,0.06);
            padding: 40px;
            overflow: hidden;
            opacity: 0;
            animation: fadeInUp 0.8s ease-out 0.4s forwards;
        }

        /* Section Headers */
        .section-header {
            margin-bottom: 32px;
        }

        .section-title {
            font-size: 24px;
            font-weight: 800;
            color: #111;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            text-transform: uppercase;
        }

        .section-title i {
            color: var(--red-accent);
        }

        .section-description {
            font-size: 16px;
            color: #444;
            font-weight: 500;
        }

        /* Form Section */
        .form-section {
            margin-bottom: 48px;
            padding-bottom: 48px;
            border-bottom: 1px solid #ececec;
        }

        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            font-weight: 600;
            color: #111;
            margin-bottom: 8px;
            font-size: 15px;
        }

        .form-control {
            border: 1px solid #ececec;
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 15px;
            transition: all 0.2s;
        }

        .form-control:focus {
            border-color: var(--red-accent);
            box-shadow: 0 0 0 3px rgba(255,45,45,0.1);
        }

        .textarea-auto {
            min-height: 120px;
            resize: vertical;
        }

        /* Buttons */
        .btn {
            font-weight: 800;
            padding: 16px 32px;
            border-radius: 14px;
            font-size: 18px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 12px;
            font-family: inherit;
            text-transform: uppercase;
        }

        .btn-primary {
            background: var(--red-accent);
            color: white;
        }

        .btn-primary:hover {
            background: #d90000;
            color: #fff;
            transform: translateY(-2px) scale(1.03);
        }

        .btn-secondary {
            background: #f7f7f7;
            color: #111;
            border: 1px solid #ececec;
        }

        .btn-secondary:hover {
            background: #ececec;
        }

        .btn-outline {
            background: white;
            color: #111;
            border: 1px solid #ececec;
        }

        .btn-outline:hover {
            background: #f7f7f7;
        }

        .btn-success {
            background: #28ca42;
            color: white;
        }

        .btn-success:hover {
            background: #1fa837;
        }

        /* Dynamic Sections */
        .dynamic-section {
            border: 1px solid #ececec;
            border-radius: 12px;
            margin-bottom: 16px;
            background: white;
        }

        .dynamic-header {
            background: #f7f7f7;
            padding: 16px 20px;
            border-bottom: 1px solid #ececec;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .dynamic-content {
            padding: 20px;
        }

        .add-button {
            background: #fff0f0;
            color: var(--red-accent);
            border: 1px solid var(--red-accent);
            padding: 12px 16px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 16px;
            width: 100%;
        }

        .add-button:hover {
            background: var(--red-accent);
            color: white;
        }

        .remove-button {
            background: none;
            border: none;
            color: var(--red-accent);
            font-size: 16px;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .remove-button:hover {
            background: rgba(255, 45, 45, 0.1);
        }

        /* Footer */
        .form-footer {
            background: #f7f7f7;
            padding: 32px;
            text-align: center;
            border-top: 1px solid #ececec;
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Status Messages */
        .status-message {
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
            display: none;
        }

        .status-success {
            background: rgba(40, 202, 66, 0.1);
            color: #28ca42;
            border: 1px solid rgba(40, 202, 66, 0.2);
        }

        .status-error {
            background: rgba(255, 45, 45, 0.1);
            color: var(--red-accent);
            border: 1px solid rgba(255, 45, 45, 0.2);
        }

        .status-warning {
            background: rgba(255, 189, 46, 0.1);
            color: #b8860b;
            border: 1px solid rgba(255, 189, 46, 0.2);
        }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 0.8s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-container {
                padding: 40px 16px 80px;
            }

            .page-title {
                font-size: 36px;
            }

            .page-subtitle {
                font-size: 18px;
            }

            .form-container {
                padding: 24px;
            }

            .section-title {
                font-size: 20px;
            }
        }

        .footer {
            background: var(--footer-black);
            color: #fff;
            padding: 48px 0 0 0;
            margin-top: 80px;
            position: relative;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .footer-logo {
            font-size: 28px;
            font-weight: 900;
            color: #fff;
            margin-bottom: 12px;
            letter-spacing: -0.03em;
        }

        .footer-logo i {
            color: var(--footer-red);
        }

        .footer-links {
            margin: 18px 0 0 0;
            display: flex;
            gap: 32px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .footer-link {
            color: var(--footer-link);
            font-weight: 700;
            text-decoration: none;
            font-size: 16px;
            transition: color 0.2s;
        }

        .footer-link:hover {
            color: var(--footer-link-hover);
            text-decoration: underline;
        }

        .footer-bottom-bar {
            width: 100%;
            height: 6px;
            background: var(--footer-red);
            margin-top: 40px;
        }

        .footer-copyright {
            color: #fff;
            opacity: 0.7;
            font-size: 15px;
            margin-top: 18px;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="d-flex align-items-center justify-content-between w-100">
                <a class="navbar-brand" href="/">
                    <i class="fas fa-file-alt me-2"></i>
                    CVLatex
                </a>
                <div class="d-flex align-items-center gap-3">
                    <a href="/manage-cvs" class="back-button">
                        <i class="fas fa-arrow-left"></i>
                        Back to My CVs
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">
                <i class="fas fa-edit me-3"></i>
                Edit Your CV
            </h1>
            <p class="page-subtitle">
                Update your information and we'll regenerate your professional CV with the latest LaTeX formatting.
            </p>
        </div>

        <!-- Status Messages -->
        <div id="statusContainer"></div>

        <!-- Loading State -->
        <div id="loadingState" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading CV data...</span>
            </div>
            <p class="mt-3 text-muted">Loading your CV information...</p>
        </div>

        <!-- CV Form -->
        <div id="cvForm" class="form-container" style="display: none;">
            <form id="editCvForm">
                <!-- Personal Information Section -->
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-user"></i>
                        Personal Information
                    </h2>
                    <p class="section-description">Basic contact details and personal information</p>
                </div>

                <div class="form-section">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label" for="name">Full Name *</label>
                                <input type="text" class="form-control" id="name" name="name" placeholder="Enter your full name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label" for="email">Email Address *</label>
                                <input type="email" class="form-control" id="email" name="email" placeholder="your.email@example.com" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label" for="phone">Phone Number</label>
                                <input type="tel" class="form-control" id="phone" name="phone" placeholder="+1 (555) 123-4567">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label" for="address">Location</label>
                                <input type="text" class="form-control" id="address" name="address" placeholder="City, State/Country">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label" for="linkedin">LinkedIn Profile</label>
                                <input type="url" class="form-control" id="linkedin" name="linkedin" placeholder="https://linkedin.com/in/yourprofile">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label" for="github">GitHub Profile</label>
                                <input type="url" class="form-control" id="github" name="github" placeholder="https://github.com/yourusername">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label" for="website">Personal Website</label>
                                <input type="url" class="form-control" id="website" name="website" placeholder="https://yourwebsite.com">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="summary">Professional Summary</label>
                        <textarea class="form-control" id="summary" name="summary" rows="4" placeholder="Brief overview of your professional background, key skills, and career objectives..."></textarea>
                    </div>
                </div>

                <!-- Education Section -->
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-graduation-cap"></i>
                        Education
                    </h2>
                    <p class="section-description">Your educational background and qualifications</p>
                </div>

                <div class="form-section">
                    <div id="educationContainer">
                        <!-- Education entries will be populated here -->
                    </div>
                    <button type="button" class="add-button" onclick="addEducation()">
                        <i class="fas fa-plus me-2"></i>
                        Add Education
                    </button>
                </div>

                <!-- Experience Section -->
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-briefcase"></i>
                        Work Experience
                    </h2>
                    <p class="section-description">Your professional work history and achievements</p>
                </div>

                <div class="form-section">
                    <div id="experienceContainer">
                        <!-- Experience entries will be populated here -->
                    </div>
                    <button type="button" class="add-button" onclick="addExperience()">
                        <i class="fas fa-plus me-2"></i>
                        Add Experience
                    </button>
                </div>

                <!-- Projects Section -->
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-code"></i>
                        Projects
                    </h2>
                    <p class="section-description">Notable projects, portfolio pieces, and achievements</p>
                </div>

                <div class="form-section">
                    <div id="projectsContainer">
                        <!-- Project entries will be populated here -->
                    </div>
                    <button type="button" class="add-button" onclick="addProject()">
                        <i class="fas fa-plus me-2"></i>
                        Add Project
                    </button>
                </div>

                <!-- Skills Section -->
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-cogs"></i>
                        Skills & Technologies
                    </h2>
                    <p class="section-description">Technical skills, programming languages, tools, and technologies</p>
                </div>

                <div class="form-section">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label" for="languages">Programming Languages</label>
                                <input type="text" class="form-control" id="languages" name="languages" placeholder="Python, JavaScript, Java, C++">
                                <small class="text-muted">Separate with commas</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label" for="frameworks">Frameworks & Libraries</label>
                                <input type="text" class="form-control" id="frameworks" name="frameworks" placeholder="React, Django, Flask, Node.js">
                                <small class="text-muted">Separate with commas</small>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label" for="tools">Tools & Technologies</label>
                                <input type="text" class="form-control" id="tools" name="tools" placeholder="Git, Docker, AWS, VSCode">
                                <small class="text-muted">Separate with commas</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label" for="databases">Databases</label>
                                <input type="text" class="form-control" id="databases" name="databases" placeholder="MySQL, PostgreSQL, MongoDB">
                                <small class="text-muted">Separate with commas</small>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="other">Other Skills</label>
                        <input type="text" class="form-control" id="other" name="other" placeholder="Project Management, Agile, Machine Learning">
                        <small class="text-muted">Separate with commas</small>
                    </div>
                </div>

                <!-- Custom Sections -->
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-plus-circle"></i>
                        Additional Sections
                    </h2>
                    <p class="section-description">Add custom sections like certifications, awards, or publications</p>
                </div>

                <div class="form-section">
                    <div id="customContainer">
                        <!-- Custom sections will be populated here -->
                    </div>
                    <button type="button" class="add-button" onclick="addCustomSection()">
                        <i class="fas fa-plus me-2"></i>
                        Add Custom Section
                    </button>
                </div>

                <!-- Form Footer -->
                <div class="form-footer">
                    <div class="d-flex flex-column flex-md-row gap-3 justify-content-center align-items-center">
                        <button type="button" class="btn btn-secondary" onclick="window.location.href='/manage-cvs'">
                            <i class="fas fa-times me-2"></i>
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary" id="updateButton">
                            <i class="fas fa-save me-2"></i>
                            Update CV
                        </button>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Your CV will be regenerated with the updated information
                        </small>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="footer">
        <div class="footer-content">
            <div class="footer-logo">
                <i class="fas fa-file-alt"></i>
                CVLatex
            </div>
            <div class="footer-links">
                <a href="/about" class="footer-link">About</a>
                <a href="/contact" class="footer-link">Contact</a>
                <a href="/privacy" class="footer-link">Privacy Policy</a>
                <a href="/terms" class="footer-link">Terms of Service</a>
            </div>
            <div class="footer-bottom-bar"></div>
            <div class="footer-copyright">
                &copy; 2023 CVLatex. All rights reserved.
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let cvId = '{{ cv_id }}';
        let educationCount = 0;
        let experienceCount = 0;
        let projectCount = 0;
        let customCount = 0;

        // Load CV data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadCVData();
        });

        async function loadCVData() {
            try {
                const response = await fetch(`/api/cv/${cvId}`);
                const data = await response.json();

                if (data.success) {
                    populateForm(data.cv_data.data);
                    document.getElementById('loadingState').style.display = 'none';
                    document.getElementById('cvForm').style.display = 'block';
                } else {
                    showError('Failed to load CV data: ' + data.error);
                }
            } catch (error) {
                showError('Error loading CV data: ' + error.message);
            }
        }

        function populateForm(cvData) {
            // Populate personal information
            document.getElementById('name').value = cvData.name || '';
            document.getElementById('email').value = cvData.email || '';
            document.getElementById('phone').value = cvData.phone || '';
            document.getElementById('address').value = cvData.address || '';
            document.getElementById('linkedin').value = cvData.linkedin || '';
            document.getElementById('github').value = cvData.github || '';
            document.getElementById('website').value = cvData.website || '';
            document.getElementById('summary').value = cvData.summary || '';

            // Populate education
            if (cvData.education && cvData.education.length > 0) {
                cvData.education.forEach(edu => addEducation(edu));
            } else {
                addEducation(); // Add one empty education entry
            }

            // Populate experience
            if (cvData.experience && cvData.experience.length > 0) {
                cvData.experience.forEach(exp => addExperience(exp));
            } else {
                addExperience(); // Add one empty experience entry
            }

            // Populate projects
            if (cvData.projects && cvData.projects.length > 0) {
                cvData.projects.forEach(proj => addProject(proj));
            }

            // Populate skills
            if (cvData.skills) {
                const skills = cvData.skills;
                document.getElementById('languages').value = skills.languages ? skills.languages.join(', ') : '';
                document.getElementById('frameworks').value = skills.frameworks ? skills.frameworks.join(', ') : '';
                document.getElementById('tools').value = skills.tools ? skills.tools.join(', ') : '';
                document.getElementById('databases').value = skills.databases ? skills.databases.join(', ') : '';
                document.getElementById('other').value = skills.other ? skills.other.join(', ') : '';
            }

            // Populate custom sections
            if (cvData.custom_sections && cvData.custom_sections.length > 0) {
                cvData.custom_sections.forEach(custom => addCustomSection(custom));
            }
        }

        // Education functions
        function addEducation(data = {}) {
            educationCount++;
            const container = document.getElementById('educationContainer');
            const educationDiv = document.createElement('div');
            educationDiv.className = 'dynamic-section';
            educationDiv.id = `education_${educationCount}`;

            educationDiv.innerHTML = `
                <div class="dynamic-header">
                    <h6 class="mb-0">Education #${educationCount}</h6>
                    <button type="button" class="remove-button" onclick="removeEducation(${educationCount})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="dynamic-content">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Degree/Program</label>
                                <input type="text" class="form-control" name="education_degree_${educationCount}" 
                                       value="${data.degree || ''}" placeholder="Bachelor of Science in Computer Science">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Institution</label>
                                <input type="text" class="form-control" name="education_institution_${educationCount}" 
                                       value="${data.institution || ''}" placeholder="University Name">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Date Range</label>
                                <input type="text" class="form-control" name="education_date_${educationCount}" 
                                       value="${data.date || ''}" placeholder="Sep 2018 - May 2022">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Location</label>
                                <input type="text" class="form-control" name="education_location_${educationCount}" 
                                       value="${data.location || ''}" placeholder="City, State">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">GPA (Optional)</label>
                                <input type="text" class="form-control" name="education_gpa_${educationCount}" 
                                       value="${data.gpa || ''}" placeholder="3.8/4.0">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Additional Details</label>
                        <textarea class="form-control" name="education_details_${educationCount}" rows="2" 
                                  placeholder="Relevant coursework, honors, activities...">${data.details || ''}</textarea>
                    </div>
                </div>
            `;

            container.appendChild(educationDiv);
        }

        function removeEducation(id) {
            const element = document.getElementById(`education_${id}`);
            if (element) {
                element.remove();
            }
        }

        // Experience functions
        function addExperience(data = {}) {
            experienceCount++;
            const container = document.getElementById('experienceContainer');
            const experienceDiv = document.createElement('div');
            experienceDiv.className = 'dynamic-section';
            experienceDiv.id = `experience_${experienceCount}`;

            const description = data.description ? data.description.join('\n') : '';

            experienceDiv.innerHTML = `
                <div class="dynamic-header">
                    <h6 class="mb-0">Experience #${experienceCount}</h6>
                    <button type="button" class="remove-button" onclick="removeExperience(${experienceCount})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="dynamic-content">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Job Title</label>
                                <input type="text" class="form-control" name="experience_title_${experienceCount}" 
                                       value="${data.title || ''}" placeholder="Software Engineer">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Company</label>
                                <input type="text" class="form-control" name="experience_company_${experienceCount}" 
                                       value="${data.company || ''}" placeholder="Company Name">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Date Range</label>
                                <input type="text" class="form-control" name="experience_date_${experienceCount}" 
                                       value="${data.date || ''}" placeholder="Jan 2022 - Present">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Location</label>
                                <input type="text" class="form-control" name="experience_location_${experienceCount}" 
                                       value="${data.location || ''}" placeholder="City, State">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Job Description & Achievements</label>
                        <textarea class="form-control" name="experience_description_${experienceCount}" rows="4" 
                                  placeholder="• Developed and maintained web applications using React and Node.js&#10;• Collaborated with cross-functional teams to deliver high-quality software&#10;• Improved application performance by 30% through code optimization">${description}</textarea>
                        <small class="text-muted">Use bullet points (•) or separate lines for each responsibility/achievement</small>
                    </div>
                </div>
            `;

            container.appendChild(experienceDiv);
        }

        function removeExperience(id) {
            const element = document.getElementById(`experience_${id}`);
            if (element) {
                element.remove();
            }
        }

        // Project functions
        function addProject(data = {}) {
            projectCount++;
            const container = document.getElementById('projectsContainer');
            const projectDiv = document.createElement('div');
            projectDiv.className = 'dynamic-section';
            projectDiv.id = `project_${projectCount}`;

            projectDiv.innerHTML = `
                <div class="dynamic-header">
                    <h6 class="mb-0">Project #${projectCount}</h6>
                    <button type="button" class="remove-button" onclick="removeProject(${projectCount})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="dynamic-content">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label class="form-label">Project Name</label>
                                <input type="text" class="form-control" name="project_title_${projectCount}" 
                                       value="${data.title || ''}" placeholder="E-commerce Web Application">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Date</label>
                                <input type="text" class="form-control" name="project_date_${projectCount}" 
                                       value="${data.date || ''}" placeholder="2023">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="project_description_${projectCount}" rows="3" 
                                  placeholder="Brief description of the project, your role, and key achievements...">${data.description || ''}</textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Technologies Used</label>
                                <input type="text" class="form-control" name="project_technologies_${projectCount}" 
                                       value="${data.technologies || ''}" placeholder="React, Node.js, MongoDB">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Project Link (Optional)</label>
                                <input type="url" class="form-control" name="project_link_${projectCount}" 
                                       value="${data.link || ''}" placeholder="https://github.com/username/project">
                            </div>
                        </div>
                    </div>
                </div>
            `;

            container.appendChild(projectDiv);
        }

        function removeProject(id) {
            const element = document.getElementById(`project_${id}`);
            if (element) {
                element.remove();
            }
        }

        // Custom section functions
        function addCustomSection(data = {}) {
            customCount++;
            const container = document.getElementById('customContainer');
            const customDiv = document.createElement('div');
            customDiv.className = 'dynamic-section';
            customDiv.id = `custom_${customCount}`;

            customDiv.innerHTML = `
                <div class="dynamic-header">
                    <h6 class="mb-0">Custom Section #${customCount}</h6>
                    <button type="button" class="remove-button" onclick="removeCustomSection(${customCount})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="dynamic-content">
                    <div class="form-group">
                        <label class="form-label">Section Title</label>
                        <input type="text" class="form-control" name="custom_title_${customCount}" 
                               value="${data.title || ''}" placeholder="Certifications, Awards, Publications, etc.">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Content</label>
                        <textarea class="form-control" name="custom_content_${customCount}" rows="4" 
                                  placeholder="List your certifications, awards, publications, or other relevant information...">${data.content || ''}</textarea>
                    </div>
                </div>
            `;

            container.appendChild(customDiv);
        }

        function removeCustomSection(id) {
            const element = document.getElementById(`custom_${id}`);
            if (element) {
                element.remove();
            }
        }

        // Form submission
        document.getElementById('editCvForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const updateButton = document.getElementById('updateButton');
            const originalText = updateButton.innerHTML;
            
            // Show loading state
            updateButton.innerHTML = '<span class="spinner"></span> Updating CV...';
            updateButton.disabled = true;

            try {
                const formData = collectFormData();
                
                const response = await fetch(`/api/cv/${cvId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess('CV updated successfully!');
                    
                    // Redirect to result page after a short delay
                    setTimeout(() => {
                        const url = `/result?latex_file=${data.latex_file}&pdf_file=${data.pdf_file || ''}&cv_id=${cvId}`;
                        window.location.href = url;
                    }, 1500);
                } else {
                    showError('Failed to update CV: ' + data.error);
                }
            } catch (error) {
                showError('Error updating CV: ' + error.message);
            } finally {
                // Reset button state
                updateButton.innerHTML = originalText;
                updateButton.disabled = false;
            }
        });

        function collectFormData() {
            const formData = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value,
                linkedin: document.getElementById('linkedin').value,
                github: document.getElementById('github').value,
                website: document.getElementById('website').value,
                summary: document.getElementById('summary').value,
                education: [],
                experience: [],
                projects: [],
                skills: {
                    languages: document.getElementById('languages').value,
                    frameworks: document.getElementById('frameworks').value,
                    tools: document.getElementById('tools').value,
                    databases: document.getElementById('databases').value,
                    other: document.getElementById('other').value
                },
                custom: []
            };

            // Collect education data
            for (let i = 1; i <= educationCount; i++) {
                const degreeEl = document.querySelector(`[name="education_degree_${i}"]`);
                if (degreeEl && degreeEl.closest('.dynamic-section')) {
                    const education = {
                        degree: degreeEl.value,
                        institution: document.querySelector(`[name="education_institution_${i}"]`).value,
                        date: document.querySelector(`[name="education_date_${i}"]`).value,
                        location: document.querySelector(`[name="education_location_${i}"]`).value,
                        gpa: document.querySelector(`[name="education_gpa_${i}"]`).value,
                        details: document.querySelector(`[name="education_details_${i}"]`).value
                    };
                    if (education.degree || education.institution) {
                        formData.education.push(education);
                    }
                }
            }

            // Collect experience data
            for (let i = 1; i <= experienceCount; i++) {
                const titleEl = document.querySelector(`[name="experience_title_${i}"]`);
                if (titleEl && titleEl.closest('.dynamic-section')) {
                    const experience = {
                        title: titleEl.value,
                        company: document.querySelector(`[name="experience_company_${i}"]`).value,
                        date: document.querySelector(`[name="experience_date_${i}"]`).value,
                        location: document.querySelector(`[name="experience_location_${i}"]`).value,
                        description: document.querySelector(`[name="experience_description_${i}"]`).value
                    };
                    if (experience.title || experience.company) {
                        formData.experience.push(experience);
                    }
                }
            }

            // Collect project data
            for (let i = 1; i <= projectCount; i++) {
                const titleEl = document.querySelector(`[name="project_title_${i}"]`);
                if (titleEl && titleEl.closest('.dynamic-section')) {
                    const project = {
                        title: titleEl.value,
                        description: document.querySelector(`[name="project_description_${i}"]`).value,
                        technologies: document.querySelector(`[name="project_technologies_${i}"]`).value,
                        date: document.querySelector(`[name="project_date_${i}"]`).value,
                        link: document.querySelector(`[name="project_link_${i}"]`).value
                    };
                    if (project.title) {
                        formData.projects.push(project);
                    }
                }
            }

            // Collect custom section data
            for (let i = 1; i <= customCount; i++) {
                const titleEl = document.querySelector(`[name="custom_title_${i}"]`);
                if (titleEl && titleEl.closest('.dynamic-section')) {
                    const custom = {
                        title: titleEl.value,
                        content: document.querySelector(`[name="custom_content_${i}"]`).value
                    };
                    if (custom.title && custom.content) {
                        formData.custom.push(custom);
                    }
                }
            }

            return formData;
        }

        // Utility functions
        function showError(message) {
            showStatus(message, 'error');
        }

        function showSuccess(message) {
            showStatus(message, 'success');
        }

        function showWarning(message) {
            showStatus(message, 'warning');
        }

        function showStatus(message, type) {
            const container = document.getElementById('statusContainer');
            const statusDiv = document.createElement('div');
            statusDiv.className = `status-message status-${type}`;
            statusDiv.innerHTML = `
                <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                ${message}
            `;
            
            container.innerHTML = '';
            container.appendChild(statusDiv);
            statusDiv.style.display = 'block';
            
            // Auto-hide after 5 seconds for success messages
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
            
            // Scroll to top to show the message
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>
</html> 