<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Your CV - Polish My CV</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --red-accent: #ff2d2d;
            --black: #111;
            --gray: #444;
            --light-gray: #f7f7f7;
            --card-radius: 20px;
            --shadow: 0 4px 32px rgba(0,0,0,0.06);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #fff;
            color: var(--black);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            min-height: 100vh;
        }
        .navbar {
            background: #fff;
            border-bottom: 1px solid #ececec;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            padding: 0;
            position: sticky;
            top: 0;
            width: 100%;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 68px;
        }
        .navbar-content {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
            height: 68px;
        }
        .navbar-logo {
            display: flex;
            align-items: center;
            font-weight: 900;
            font-size: 26px;
            color: var(--black);
            text-decoration: none;
            gap: 10px;
            letter-spacing: -0.03em;
        }
        .navbar-logo-icon {
            width: 38px;
            height: 38px;
            background: var(--red-accent);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 22px;
        }
        .navbar-links {
            display: flex;
            align-items: center;
            gap: 32px;
        }
        .navbar-link {
            color: var(--gray);
            font-weight: 700;
            font-size: 17px;
            text-decoration: none;
            text-transform: uppercase;
            transition: color 0.2s;
            letter-spacing: 0.01em;
        }
        .navbar-link:hover {
            color: var(--black);
        }
        .main-section {
            display: flex;
            align-items: stretch;
            justify-content: center;
            min-height: calc(100vh - 68px);
            height: calc(100vh - 68px);
            padding: 0;
            gap: 0;
            background: #f7f7f7;
        }
        .left-col {
            flex: 0 0 40%;
            max-width: 40%;
            min-width: 340px;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            justify-content: stretch;
            background: #fff;
            padding: 0;
            z-index: 2;
            height: 100%;
            border-right: 1px solid #e0e0e0;
        }
        .right-col {
            flex: 0 0 60%;
            max-width: 60%;
            display: flex;
            align-items: center;
            justify-content: center;
            height: calc(100vh - 68px);
            position: relative;
            background: #f7f7f7;
            padding: 0;
        }
        .right-col.review-active {
            display: flex !important;
            flex-direction: column !important;
            align-items: stretch !important;
            justify-content: flex-start !important;
            height: 100% !important;
            width: 100% !important;
            padding: 0 !important;
            flex: 1 1 0 !important;
            min-height: 0 !important;
            max-width: none !important;
        }
        .review-illustration-section {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .upload-card {
            background: #fff;
            border-radius: 0;
            box-shadow: none;
            padding: 48px 40px;
            width: 100%;
            height: 100%;
            min-height: 0;
            display: flex;
            flex-direction: column;
            gap: 36px;
            justify-content: space-between;
            box-sizing: border-box;
        }
        .hero-headline {
            font-size: 42px;
            font-weight: 800;
            color: var(--black);
            margin-bottom: 16px;
            line-height: 1.2;
            letter-spacing: -0.03em;
            text-align: left;
        }
        .hero-sub {
            font-size: 20px;
            color: var(--gray);
            font-weight: 500;
            margin-bottom: 32px;
            text-align: left;
            line-height: 1.5;
        }
        .upload-area {
            border: 2px dashed #e0e0e0;
            border-radius: 12px;
            padding: 32px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #fafafa;
        }
        .upload-area:hover {
            border-color: var(--red-accent);
            background: #fff;
        }
        .job-label {
            font-size: 16px;
            font-weight: 600;
            color: var(--black);
            margin-bottom: 8px;
            text-transform: none;
        }
        .job-select {
            width: 100%;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 24px;
            background: #fff;
            color: var(--black);
            text-transform: none;
            transition: all 0.2s ease;
        }
        .job-select:focus {
            border-color: var(--red-accent);
            outline: none;
            box-shadow: 0 0 0 2px rgba(255, 45, 45, 0.1);
        }
        .job-desc-label {
            font-size: 16px;
            font-weight: 600;
            color: var(--black);
            margin-bottom: 8px;
            text-transform: none;
        }
        .job-desc-area {
            width: 100%;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            font-size: 16px;
            font-weight: 500;
            min-height: 140px;
            margin-bottom: 24px;
            color: var(--black);
            background: #fff;
            resize: vertical;
            transition: all 0.2s ease;
        }
        .job-desc-area:focus {
            border-color: var(--red-accent);
            outline: none;
            box-shadow: 0 0 0 2px rgba(255, 45, 45, 0.1);
        }
        .review-btn {
            background: var(--black);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            padding: 16px 0;
            width: 100%;
            margin-top: 0;
            cursor: pointer;
            text-transform: none;
            letter-spacing: 0;
            transition: all 0.2s ease;
        }
        .review-btn:hover {
            background: #222;
            transform: translateY(-1px);
        }
        .illustration {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            margin: 0;
        }
        .illustration-img {
            width: 180px;
            height: 180px;
            background: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.04);
        }
        .illustration-img svg {
            width: 100px;
            height: 100px;
        }
        .illustration-text {
            font-size: 18px;
            color: #222;
            text-align: center;
            font-weight: 600;
            line-height: 1.5;
            max-width: 300px;
            margin: 0 auto;
        }
        #reviewResults {
            display: none;
        }
        .cv-review-panel {
            width: 100%;
            height: 100%;
            min-height: 0;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 32px 24px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            box-sizing: border-box;
            margin: 0;
            max-width: none;
            flex: 1 1 0;
            min-height: 0;
            max-height: none;
        }
        .cv-review-score {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff2d2d 60%, #ff7e5f 100%);
            color: #fff;
            font-size: 2.2rem;
            font-weight: 800;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(255,45,45,0.15);
            border: 6px solid #fff;
        }
        .cv-review-score-label {
            font-size: 1rem;
            font-weight: 600;
            margin-top: 2px;
            letter-spacing: 0;
            color: #fff;
        }
        .cv-review-sections {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 24px;
            flex: 1 1 0;
            min-height: 0;
            height: 100%;
            overflow-y: auto;
        }
        .cv-review-section {
            background: #fafafa;
            border-radius: 12px;
            padding: 24px;
            box-shadow: none;
            border-left: none;
        }
        .cv-review-section-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            letter-spacing: 0;
            color: var(--black);
        }
        .cv-review-section-title i {
            font-size: 16px;
            color: var(--red-accent);
        }
        .cv-review-section ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .cv-review-section li {
            background: #fff;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 14px;
            color: var(--black);
            font-weight: 500;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            border: 1px solid #e0e0e0;
            margin-bottom: 0;
            display: block;
        }
        @media (max-width: 1200px) {
            .main-section {
                flex-direction: column;
                min-height: unset;
                height: auto;
                padding: 0;
            }
            .left-col, .right-col {
                max-width: 100%;
                width: 100%;
                min-width: unset;
                height: auto;
            }
            .upload-card {
                border-radius: 0;
                height: auto;
                padding: 32px 24px;
            }
            .right-col {
                padding: 24px;
            }
        }
        @media (max-width: 900px) {
            .main-section {
                flex-direction: column;
                padding: 20px 0;
            }
            .left-col, .right-col {
                width: 100%;
                min-width: unset;
                max-width: 100vw;
            }
            .upload-card {
                max-width: 100vw;
                padding: 40px 10px;
            }
            .right-col {
                margin-top: 24px;
            }
            .cv-review-panel { padding: 18px 4px; }
            .cv-review-score { width: 80px; height: 80px; font-size: 2rem; }
            .cv-review-section { padding: 16px 8px; }
        }
        @media (max-width: 700px) {
            .hero-headline {
                font-size: 32px;
            }
            .hero-sub {
                font-size: 16px;
            }
            .upload-card {
                padding: 24px 4px;
            }
        }
        .emoji-circle {
            width: 120px;
            height: 120px;
            background: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 16px rgba(0,0,0,0.04);
        }
        .review-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #f7f7f7;
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            transition: opacity 0.5s;
            overflow: auto;
        }
        .review-animation {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.7s;
        }
        .checkmark-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: #fff;
            box-shadow: 0 2px 8px rgba(255,45,45,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 18px;
        }
        .checkmark-circle svg {
            width: 60px;
            height: 60px;
            stroke: #28ca42;
            stroke-width: 4;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
            animation: checkmarkDraw 0.7s cubic-bezier(0.65,0,0.45,1) forwards;
        }
        @keyframes checkmarkDraw {
            0% { stroke-dasharray: 0, 100; }
            100% { stroke-dasharray: 100, 0; }
        }
        .reviewed-text {
            font-size: 2.2rem;
            font-weight: 800;
            color: #28ca42;
            margin-bottom: 12px;
            letter-spacing: -0.02em;
            animation: fadeIn 1s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        #fullReviewPanel {
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            padding: 0 16px;
            display: flex;
            flex-direction: column;
            align-items: stretch;
        }
        .full-review-close {
            margin: 24px auto 0 auto;
            padding: 12px 32px;
            background: #ff2d2d;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s;
        }
        .full-review-close:hover {
            background: #d90000;
        }
        .full-review-card {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.08);
            max-width: 900px;
            width: 100%;
            margin: 40px auto 0 auto;
            padding: 32px 24px 24px 24px;
            display: flex;
            flex-direction: column;
            align-items: stretch;
        }
        .review-overlay-content {
            display: flex;
            width: 100%;
            height: 100%;
            align-items: stretch;
        }
        .review-left, .review-right {
            width: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 0;
        }
        .review-right {
            padding: 32px 10px;
            background: linear-gradient(135deg, #ff2d2d 0%, #ff7e5f 100%);
            color: #fff;
            text-align: center;
        }
        .review-cta-title {
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 18px;
            letter-spacing: -0.03em;
        }
        .review-cta-desc {
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 32px;
            color: #fff;
            opacity: 0.95;
        }
        .review-cta-btn {
            background: #fff;
            color: #ff2d2d;
            border: none;
            border-radius: 10px;
            font-size: 1.3rem;
            font-weight: 800;
            padding: 18px 44px;
            cursor: pointer;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            transition: background 0.2s, color 0.2s;
        }
        .review-cta-btn:hover {
            background: #ffeaea;
            color: #d90000;
        }
        @media (max-width: 900px) {
            .review-overlay-content {
                flex-direction: column;
            }
            .review-left, .review-right {
                width: 100%;
                min-width: 0;
                min-height: 0;
            }
            .review-right {
                padding: 32px 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-code-branch"></i>
                Polish My CV
            </a>
            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <i class="fas fa-bars text-white"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#features">Features</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#how-it-works">Process</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#demo">Demo</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link nav-cta" href="/upload">Start Free</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/create-cv" style="margin-left: 8px;">Create CV</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="main-section" id="mainSection">
        <div class="left-col" id="leftCol">
            <div class="upload-card">
                <div>
                    <div class="hero-headline">Fix your resume using AI</div>
                    <div class="hero-sub">Find out if your resume fits the job you're applying for</div>
                </div>
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="upload-area" style="border: 2px dashed #ccc; padding: 20px; text-align: center; margin-bottom: 20px; border-radius: 12px; cursor: pointer;">
                        <input type="file" name="cv_file" id="cv_file" accept=".pdf,.docx" style="display: none;">
                        <div id="uploadText">
                            <i class="fas fa-upload" style="font-size: 48px; color: var(--red-accent); margin-bottom: 10px;"></i>
                            <div style="font-size: 20px; font-weight: bold;">Click to upload your resume</div>
                            <div style="font-size: 14px; color: #666;">PDF or DOCX files only</div>
                        </div>
                    </div>
                </form>
                <div>
                    <div class="job-label">Enter the job you are applying for</div>
                    <input class="job-select" id="jobSelect" list="jobRoles" placeholder="e.g. Senior Software Engineer" autocomplete="off">
                    <datalist id="jobRoles">
                        <option value="Senior Software Engineer">
                        <option value="Product Manager">
                        <option value="Data Scientist">
                        <option value="UX Designer">
                        <option value="Other">
                    </datalist>
                </div>
                <div>
                    <div class="job-desc-row">
                        <div class="job-desc-label">Job Description</div>
                        <span class="generate-link" id="generateLink">(Generate)</span>
                    </div>
                    <textarea class="job-desc-area" id="jobDesc" placeholder="Input Job Description. Write down the requirements for the job you are applying for. For best results, you should copy–paste the JD from LinkedIn or Career Website. Or you can auto–generate by clicking the button above."></textarea>
                </div>
                <button class="review-btn" id="reviewBtn">Review my resume &rarr;</button>
            </div>
        </div>
        <div class="right-col" id="rightCol">
            <section class="review-illustration-section">
                <div class="illustration" id="illustrationBlock">
                    <div class="illustration-img emoji-circle" style="margin-bottom: 24px;">
                        <span id="emojiCycler" style="font-size: 3rem; transition: opacity 0.4s; display: inline-block;">📄</span>
                    </div>
                    <div class="illustration-text">Upload your resume to get personalized recommendations.</div>
                </div>
            </section>
            <div id="reviewResults"></div>
        </div>
        <div id="reviewOverlay" class="review-overlay" style="display:none;">
            <div class="review-animation" id="reviewAnimation">
                <div class="checkmark-circle">
                    <svg viewBox="0 0 52 52"><circle cx="26" cy="26" r="25" fill="none"/><path d="M14 27l7 7 16-16" fill="none"/></svg>
                </div>
                <div class="reviewed-text">Reviewed!</div>
            </div>
            <div id="fullReviewPanel" style="display:none;"></div>
        </div>
    </div>
    <footer class="footer mt-auto py-3 bg-light">
        <div class="container text-center">
            <span class="text-muted">© 2023 Polish My CV. All rights reserved.</span>
        </div>
    </footer>
    <script>
        // Replace the old upload button code with this new implementation
        const uploadArea = document.querySelector('.upload-area');
        const fileInput = document.getElementById('cv_file');
        const uploadText = document.getElementById('uploadText');

        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        let extractedText = '';

        fileInput.addEventListener('change', async (e) => {
            if (fileInput.files.length > 0) {
                const fileName = fileInput.files[0].name;
                uploadText.innerHTML = `
                    <i class="fas fa-check" style="font-size: 48px; color: #28ca42; margin-bottom: 10px;"></i>
                    <div style="font-size: 20px; font-weight: bold;">${fileName}</div>
                    <div style="font-size: 14px; color: #666;">Click to change file</div>
                `;
                // Upload the file and get extracted text
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                try {
                    const uploadResponse = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (!uploadResponse.ok) {
                        throw new Error('Upload failed');
                    }

                    const uploadData = await uploadResponse.json();

                    if (uploadData.success && uploadData.extracted_text) {
                        extractedText = uploadData.extracted_text;
                    } else {
                        extractedText = '';
                        alert(uploadData.error || 'Failed to extract text from CV.');
                    }
                } catch (err) {
                    extractedText = '';
                    alert('Error uploading CV. Please try again.');
                    console.error('Upload error:', err);
                }
            }
        });

        // Drag and drop support
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = 'var(--red-accent)';
        });

        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#ccc';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#ccc';
            fileInput.files = e.dataTransfer.files;
            if (fileInput.files.length > 0) {
                const fileName = fileInput.files[0].name;
                uploadText.innerHTML = `
                    <i class="fas fa-check" style="font-size: 48px; color: #28ca42; margin-bottom: 10px;"></i>
                    <div style="font-size: 20px; font-weight: bold;">${fileName}</div>
                    <div style="font-size: 14px; color: #666;">Click to change file</div>
                `;
            }
        });
        // Gemini job description generation
        document.getElementById('generateLink').onclick = async function() {
            const role = document.getElementById('jobSelect').value.trim();
            if (!role) {
                alert('Please enter a job role first.');
                return;
            }
            const jobDescArea = document.getElementById('jobDesc');
            jobDescArea.value = 'Generating job description for "' + role + '"...';
            try {
                const response = await fetch('/generate-job-desc', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role })
                });
                const data = await response.json();
                if (data && data.description) {
                    jobDescArea.value = data.description;
                } else {
                    jobDescArea.value = '';
                    alert('Could not generate job description.');
                }
            } catch (e) {
                jobDescArea.value = '';
                alert('Error generating job description.');
            }
        };
        // Review my resume button handler
        document.getElementById('reviewBtn').onclick = async function() {
            const role = document.getElementById('jobSelect').value.trim();
            const jobDesc = document.getElementById('jobDesc').value.trim();
            if (!extractedText) {
                alert('Please upload a valid CV file first.');
                return;
            }
            const reviewBtn = document.getElementById('reviewBtn');
            reviewBtn.innerText = 'Reviewing...';
            reviewBtn.disabled = true;
            const reviewResults = document.getElementById('reviewResults');
            reviewResults.style.display = 'none';
            reviewResults.innerHTML = '';
            document.querySelector('.right-col').classList.remove('review-active');
            try {
                console.log('Starting CV review...');
                const response = await fetch('/api/review-cv', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cv_text: extractedText,
                        job_description: jobDesc
                    })
                });
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Review API Response:', data);
                console.log('Data has success:', 'success' in data);
                console.log('Data has redirect_url:', 'redirect_url' in data);
                
                if (data.error) {
                    alert('Error: ' + data.error);
                } else if (data.success && data.redirect_url) {
                    // Redirect to the dedicated review page
                    console.log('Redirecting to:', data.redirect_url);
                    console.log('About to redirect...');
                    window.location.href = data.redirect_url;
                    return; // Exit early to prevent fallback code
                } else {
                    console.log('Falling back to old review display');
                    console.log('data.success:', data.success);
                    console.log('data.redirect_url:', data.redirect_url);
                    document.getElementById('illustrationBlock').style.display = 'none';
                    let html = '';
                    html += `
                        <div class="cv-review-panel">
                            <div class="cv-review-score">
                                <span id="cvScore">${data.rating ?? '--'}</span>
                                <div class="cv-review-score-label">Score</div>
                            </div>
                            <div class="cv-review-sections">
                                <div class="cv-review-section strengths">
                                    <div class="cv-review-section-title"><i class="fas fa-thumbs-up"></i> Top 5 Strengths</div>
                                    <ul>${(data.strengths || []).slice(0, 5).map(s => `<li>${s}</li>`).join('')}</ul>
                                </div>
                                <div class="cv-review-section weaknesses">
                                    <div class="cv-review-section-title"><i class="fas fa-thumbs-down"></i> Worst 5 Weaknesses</div>
                                    <ul>${(data.weaknesses || []).slice(0, 5).map(w => `<li>${w}</li>`).join('')}</ul>
                                </div>
                                <div class="cv-review-section suggestions">
                                    <div class="cv-review-section-title"><i class="fas fa-lightbulb"></i> Top Suggestions</div>
                                    <ul>${(data.suggestions || []).slice(0, 5).map(s => `<li>${s}</li>`).join('')}</ul>
                                </div>
                            </div>
                        </div>
                    `;
                    // Hide left and right columns, show overlay
                    document.getElementById('leftCol').style.display = 'none';
                    document.getElementById('rightCol').style.display = 'none';
                    document.getElementById('reviewOverlay').style.display = 'flex';
                    document.getElementById('reviewAnimation').style.display = 'flex';
                    document.getElementById('fullReviewPanel').style.display = 'none';
                    // After 1.5s, hide animation and show review
                    setTimeout(() => {
                        document.getElementById('reviewAnimation').style.display = 'none';
                        document.getElementById('fullReviewPanel').innerHTML = `
                            <div class="review-overlay-content">
                                <div class="review-left">
                                    <div class="full-review-card">
                                        <div class="cv-review-score">
                                            <span id="cvScore">${data.rating ?? '--'}</span>
                                            <div class="cv-review-score-label">Score</div>
                                        </div>
                                        <div class="cv-review-section strengths">
                                            <div class="cv-review-section-title"><i class="fas fa-thumbs-up"></i> Top 5 Strengths</div>
                                            <ul>${(data.strengths || []).slice(0, 5).map(s => `<li>${s}</li>`).join('')}</ul>
                                        </div>
                                        <div class="cv-review-section weaknesses">
                                            <div class="cv-review-section-title"><i class="fas fa-thumbs-down"></i> Worst 5 Weaknesses</div>
                                            <ul>${(data.weaknesses || []).slice(0, 5).map(w => `<li>${w}</li>`).join('')}</ul>
                                        </div>
                                        <div class="cv-review-section suggestions">
                                            <div class="cv-review-section-title"><i class="fas fa-lightbulb"></i> Top Suggestions</div>
                                            <ul>${(data.suggestions || []).slice(0, 5).map(s => `<li>${s}</li>`).join('')}</ul>
                                        </div>
                                        <button class="full-review-close" onclick="window.location.reload()">Upload another CV</button>
                                    </div>
                                </div>
                                <div class="review-right">
                                    <div class="review-cta-title">Generate your perfect resume, today</div>
                                    <div class="review-cta-desc">Transform your CV into a stunning, job-winning resume in seconds. Our AI-powered tool makes it easy!</div>
                                    <button class="review-cta-btn" onclick="generateImprovedResume()">Generate Resume</button>
                                </div>
                            </div>
                        `;
                        document.getElementById('fullReviewPanel').style.display = 'flex';
                    }, 1500);

                    if (data.rating !== undefined && document.getElementById('gaugeScore')) {
                        document.getElementById('gaugeScore').textContent = data.rating;
                    }
                    // Debug: log API response and generated HTML
                    console.log('Review API response:', data);
                    console.log('Review HTML:', html);
                }
            } catch (e) {
                alert('Error reviewing CV.');
            } finally {
                reviewBtn.innerText = 'Review my resume &rarr;';
                reviewBtn.disabled = false;
            }
        };
        // Generate improved resume function
        async function generateImprovedResume() {
            const generateBtn = document.querySelector('.review-cta-btn');
            const originalText = generateBtn.textContent;
            
            // Show loading state
            generateBtn.textContent = 'Generating...';
            generateBtn.disabled = true;
            
            try {
                const response = await fetch('/api/generate-improved-resume', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Redirect to the improved resume preview page
                    window.location.href = `/improved-resume-preview/${data.session_id}`;
                } else {
                    alert('Error generating improved resume: ' + (data.error || 'Unknown error'));
                    generateBtn.textContent = originalText;
                    generateBtn.disabled = false;
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error generating improved resume. Please try again.');
                generateBtn.textContent = originalText;
                generateBtn.disabled = false;
            }
        }

        // Emoji cycling animation
        const emojis = ["📄", "🤖", "✨", "📝", "💼"];
        let emojiIndex = 0;
        const emojiSpan = document.getElementById("emojiCycler");
        setInterval(() => {
            emojiSpan.style.opacity = 0;
            setTimeout(() => {
                emojiIndex = (emojiIndex + 1) % emojis.length;
                emojiSpan.textContent = emojis[emojiIndex];
                emojiSpan.style.opacity = 1;
            }, 400);
        }, 5000);
    </script>
</body>
</html>